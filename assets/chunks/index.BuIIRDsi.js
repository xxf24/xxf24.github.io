var ie=Object.defineProperty;var ae=(i,e,t)=>e in i?ie(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var M=(i,e,t)=>ae(i,typeof e!="symbol"?e+"":e,t);import{at as le,au as re,d as W,o as f,a as h,n as q,t as p,y as c,F as $,Y as Z,j as de,_ as ee,aw as ue,B as b,K as ce,J as z,c as I,C as fe,L as he,M as ge,aq as pe,b as l,e as _,q as J,R as G,k as me,T as ve,a8 as be,w as K,ax as X}from"./framework.D5y5L8WJ.js";import{s as ye,b as v}from"./utils.DUgioOpr.js";class ke{constructor(){M(this,"state");M(this,"timer");M(this,"board");M(this,"blocks",[]);M(this,"flags",[]);this.init()}init(e={w:9,h:9,m:10}){this.board={...e},this.flags.length=0,this.blocks=Array.from({length:this.board.w*this.board.h},(t,o)=>({uid:o})),this.state="ready",this.resetTimer()}posToUid(e){return e.x+e.y*this.board.w}uidToPos(e){return{x:e%this.board.w,y:Math.floor(e/this.board.w)}}resetTimer(){this.timer={start:Date.now(),duration:0}}placeMines(e){const{w:t,h:o,m:n}=this.board,r=[e];ye([...Array.from({length:t*o}).keys()],n,r).forEach(d=>this.blocks[d].mine=!0)}load(e){const{board:t,blocks:o,duration:n}=e;this.init(t),o.forEach(r=>{this.blocks[r.uid]=r,r.flag&&this.flags.push(r.uid)}),this.timer.duration=n,this.state="playing"}snap(){const e={board:this.board,blocks:this.blocks.filter(t=>t.open||t.mine||t.flag),duration:Date.now()-this.timer.start+this.timer.duration};return JSON.stringify(e)}restart(){this.state!=="ready"&&(this.flags.length=0,this.blocks.forEach(e=>{e.open=!1,e.flag=!1,e.bomb=!1}),this.state="playing",this.resetTimer())}open(e,t=!0){if(this.state==="win"||this.state==="lose")return;const o=this.posToUid(e);this.state==="ready"&&(this.placeMines(o),this.resetTimer(),this.state="playing");const n=this.blocks[o];if(n.flag){this.mark(e);return}if(n.open&&t){this.openAdjacent(e);return}this.doOpen(n),this.doVictoryJudgement("open")}mark(e){if(this.state==="win"||this.state==="lose")return;const t=this.posToUid(e);this.state==="ready"&&(this.placeMines(t),this.resetTimer(),this.state="playing");const o=this.blocks[t];if(o.open)return;o.flag=!o.flag;const n=this.flags.indexOf(t);n>-1?this.flags.splice(n,1):this.flags.push(t),this.doVictoryJudgement("flag")}openAdjacent(e){const t=this.posToUid(e),o=this.blocks[t],n=this.getAdjacentMinesCount(o);if(n===0)return;let r=0;const d=[];this.getSiblings(t).filter(g=>!g.open).forEach(g=>{g.flag?r++:d.push(g)}),r===n&&(d.forEach(g=>this.doOpen(g)),this.doVictoryJudgement("open"))}getHighlight(e){if(this.state==="win"||this.state==="lose")return[];const t=this.posToUid(e);return this.blocks[t].open?this.getSiblings(t).filter(o=>!o.open&&!o.flag).map(o=>o.uid):[t]}doVictoryJudgement(e){let t;const o=this.board.m;if(e==="open"){let n=0;for(let r=0;r<this.blocks.length&&n<=o;r++)this.blocks[r].open||n++;t=n===o}else t=o===this.flags.length&&this.flags.every(n=>this.blocks[n].mine);t&&(this.state="win",this.blocks.forEach(n=>{n.mine?(n.flag=!0,this.flags.includes(n.uid)||this.flags.push(n.uid)):n.open=!0}))}doOpen(e){e.open=!0,e.mine?(e.bomb=!0,this.state="lose",this.blocks.forEach(t=>{(t.mine||t.flag)&&(t.open=!0)})):this.doAutoOpen(e)}doAutoOpen(e){this.getAdjacentMinesCount(e)===0&&this.getSiblings(e.uid).forEach(t=>{!t.open&&!t.flag&&(t.open=!0,this.doAutoOpen(t))})}getAdjacentMinesCount(e){if(e.adjacentMinesCount===void 0){const t=this.getSiblings(e.uid);e.adjacentMinesCount=t.filter(o=>o.mine).length}return e.adjacentMinesCount}getSiblings(e){const t=[],{w:o,h:n}=this.board,r=this.uidToPos(e),d=[[1,1],[1,0],[1,-1],[0,1],[0,-1],[-1,1],[-1,0],[-1,-1]];for(const[S,g]of d){const x=S+r.x,w=g+r.y;if(x<0||x>=o||w<0||w>=n)continue;const L=this.blocks[this.posToUid({x,y:w})];t.push(L)}return t}}function xe(){const i=le(new ke),{state:e,board:t,blocks:o,flags:n,timer:r}=re(i);return{state:e,board:t,blocks:o,flags:n,timer:r,init:v(i.init,i),load:v(i.load,i),snap:v(i.snap,i),restart:v(i.restart,i),open:v(i.open,i),mark:v(i.mark,i),openAdjacent:v(i.openAdjacent,i),uidToPos:v(i.uidToPos,i),posToUid:v(i.posToUid,i),getHighlight:v(i.getHighlight,i)}}const Q=[{key:"easy",text:"初级",w:9,h:9,m:10},{key:"medium",text:"中级",w:16,h:16,m:40},{key:"hard",text:"高级",w:30,h:16,m:99}],k={ready:"🙂",playing:"🤔",win:"😎",lose:"😵",flag:"🚩",mine:"💣",bomb:"💥",timer:"⏱️",fast:"🚀"},we={0:"transparent",1:"#3b82f6",2:"#22c55e",3:"#ef4444",4:"#6366f1",5:"#f97316",6:"#a855f7",7:"#14b8a6",8:"#ec4899"},Me={key:0,class:"item bg-red-600/70"},_e={key:1,class:"item"},Ce=W({__name:"block",props:{meta:{},highlight:{type:Boolean}},setup(i){return(e,t)=>(f(),h("div",{class:q(["h-full w-full text-lg font-bold font-mono border border-solid border-gray-500/10 rounded of-hidden",!e.highlight&&!e.meta.open&&"bg-gray-600/10 dark:bg-gray-500/10"])},[e.meta.flag?(f(),h("div",{key:0,class:q(["item",e.meta.open&&!e.meta.mine&&"bg-red-600/60"])},p(c(k).flag),3)):e.meta.open?(f(),h($,{key:1},[e.meta.bomb?(f(),h("div",Me,p(c(k).bomb),1)):e.meta.mine?(f(),h("div",_e,p(c(k).mine),1)):(f(),h("div",{key:2,class:"item",style:Z({color:c(we)[e.meta.adjacentMinesCount]})},p(e.meta.adjacentMinesCount),5))],64)):de("",!0)],2))}}),Te=ee(Ce,[["__scopeId","data-v-625095ea"]]),je={class:"relative select-none"},Se={key:0,class:"w-80 md:w-92 of-hidden rounded-lg bg-slate-100/60 p-8 text-center dark:bg-neutral-800/60"},Ee={key:1,class:"flex flex-col gap-4"},Be={class:"w-full mx-auto flex gap-2"},Ue=["onClick"],Ae={class:"flex items-center justify-between"},$e={class:"text-lg font-bold"},Le={class:"font-mono text-red-600"},Oe={class:"text-lg font-bold"},Pe={class:"font-mono text-red-600"},De={class:"max-w-full of-auto text-center"},Ve={class:"flex items-center gap-4"},Fe={for:"toggleFlag"},Ie={for:"toggleFast"},A="g-minesweeper-last-game",Je=W({__name:"main",setup(i){const{state:e,board:t,blocks:o,timer:n,flags:r,...d}=xe(),S=ue(),g=b(0);ce(()=>{if(e.value==="ready")g.value=0;else if(e.value==="playing"){const{start:a,duration:s}=n.value;g.value=(S.value-a+s)/1e3}});function x(a){return Math.min(999,Math.floor(a)).toString().padStart(3,"0")}const w=b("easy");function L(a){w.value=a,O()}function O(){const{w:a,h:s,m:u}=Q.find(m=>m.key===w.value);d.init({w:a,h:s,m:u})}const y=b(!0),C=b(!1);let N=y.value;z(C,a=>{a?(N=y.value,y.value=!1):y.value=N}),z(y,a=>{a&&(C.value=!1)});const P=b(32),D=b(2),te=I(()=>({"--side":`${P.value}px`,"--gap":`${D.value}px`})),E=fe("gameBoard"),T=b(!1),B=b({x:0,y:0}),j=I(()=>({x:Math.floor(B.value.x/(P.value+D.value)),y:Math.floor(B.value.y/(P.value+D.value))})),se=I(()=>T.value?d.getHighlight(j.value):[]);function oe(a){if(E.value){T.value=!0;const s=E.value.getBoundingClientRect();B.value={x:a.clientX-s.x,y:a.clientY-s.y},document.body.addEventListener("pointermove",R),document.body.addEventListener("pointerup",U),document.body.addEventListener("pointercancel",U)}}function R(a){const s=E.value.getBoundingClientRect(),u=a.clientX-s.left,m=a.clientY-s.top;u<0||u>s.width||m<0||m>s.height?T.value=!1:(T.value=!0,B.value={x:u,y:m})}function U(){T.value=!1,document.body.removeEventListener("pointermove",R),document.body.removeEventListener("pointerup",U),document.body.removeEventListener("pointercancel",U)}const V=b(!1);he(()=>{V.value=!!localStorage.getItem(A)}),ge(()=>H()),pe("pagehide",()=>H());const H=(()=>{let a=!1;return()=>{!a&&e.value==="playing"&&(a=!0,localStorage.setItem(A,d.snap()))}})();function ne(){try{const a=JSON.parse(localStorage.getItem(A)??"");d.load(a)}catch{O()}finally{Y()}}function Y(){V.value=!1,localStorage.removeItem(A)}return(a,s)=>(f(),h("div",je,[V.value?(f(),h("div",Se,[s[8]||(s[8]=l("div",{class:"mb-8 text-lg"},"恢复对局 🤔",-1)),s[9]||(s[9]=l("div",{class:"mb-6 text-sm"},"有上次未完成的对局，是否继续？",-1)),l("div",{class:"flex items-center justify-center gap-4"},[l("button",{class:"text-red-600",onClick:Y},s[6]||(s[6]=[l("i",{class:"i-lucide-x text-xl mr-1"},null,-1),_("取消 ")])),l("button",{class:"text-green-600",onClick:ne},s[7]||(s[7]=[l("i",{class:"i-lucide-check text-xl mr-1"},null,-1),_("确认 ")]))])])):(f(),h("div",Ee,[l("div",Be,[(f(!0),h($,null,J(c(Q),u=>(f(),h("button",{key:u.key,onClick:m=>L(u.key)},p(u.text),9,Ue))),128)),l("button",{class:"ml-auto",title:"重玩本局",onClick:s[0]||(s[0]=(...u)=>d.restart&&d.restart(...u))},s[10]||(s[10]=[l("i",{class:"i-lucide-repeat-1"},null,-1)]))]),l("div",Ae,[l("div",$e,[_(p(c(k).mine)+" ",1),l("span",Le,p(x(c(t).m-c(r).length)),1)]),l("button",{class:"relative h-9 w-16 text-lg font-bold",onClick:O},[G(ve,{name:"slide-up",mode:"out-in"},{default:me(()=>[(f(),h("span",{key:c(e),class:"absolute w-full h-full flex items-center justify-center"},p(c(k)[c(e)]),1))]),_:1})]),l("div",Oe,[_(p(c(k).timer)+" ",1),l("span",Pe,p(x(g.value)),1)])]),l("div",De,[l("div",{ref_key:"gameBoard",ref:E,class:"relative flex flex-col gap-y-$gap",style:Z(te.value),onPointerdown:oe,onClick:s[1]||(s[1]=u=>C.value?d.mark(j.value):d.open(j.value,y.value)),onContextmenu:s[2]||(s[2]=be(u=>d.mark(j.value),["prevent"])),onDblclick:s[3]||(s[3]=u=>d.openAdjacent(j.value))},[(f(!0),h($,null,J(c(t).h,(u,m)=>(f(),h("div",{key:m,class:"flex gap-x-$gap"},[(f(!0),h($,null,J(c(t).w,(Ne,F)=>(f(),h("div",{key:F,class:"h-$side w-$side shrink-0"},[G(Te,{meta:c(o)[d.posToUid({x:F,y:m})],highlight:se.value.includes(d.posToUid({x:F,y:m}))},null,8,["meta","highlight"])]))),128))]))),128))],36)]),l("div",Ve,[l("label",Fe,[K(l("input",{id:"toggleFlag",type:"checkbox","onUpdate:modelValue":s[4]||(s[4]=u=>C.value=u)},null,512),[[X,C.value]]),_(" "+p(c(k).flag),1)]),l("label",Ie,[K(l("input",{id:"toggleFast",type:"checkbox","onUpdate:modelValue":s[5]||(s[5]=u=>y.value=u)},null,512),[[X,y.value]]),_(" "+p(c(k).fast),1)])])]))]))}}),qe=ee(Je,[["__scopeId","data-v-1f850d29"]]);export{qe as default};
