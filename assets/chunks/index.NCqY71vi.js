var J=Object.defineProperty;var F=(d,e,s)=>e in d?J(d,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):d[e]=s;var x=(d,e,s)=>F(d,typeof e!="symbol"?e+"":e,s);import{B as z,aq as M,ar as q,as as R,at as K,au as P,av as U,J as T,M as W,d as j,c as Y,o as w,a as _,t as b,n as H,_ as I,C,L as Q,b as o,y as g,w as V,v as X,Y as O,F as B,q as A,R as L,k as Z,j as ee,T as te}from"./framework.D5y5L8WJ.js";import{s as se,b as E}from"./utils.DUgioOpr.js";const ie={ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",w:"up",a:"left",s:"down",d:"right"};function le(d={}){const{enableKeyboardInput:e=!0,enablePointerSwipe:s=!0,element:i,onMoved:t}=d,l=z(),a=[];if(e&&a.push(M("keydown",n=>{const c=ie[n.key];c&&(n.preventDefault(),t==null||t(c),l.value=c)})),s){const{stop:n}=q(i,{threshold:30,onSwipeEnd:(c,v)=>{v!=="none"&&(c.preventDefault(),t==null||t(v),l.value=v)}});a.push(n)}const h=()=>a.forEach(n=>n());return R(()=>h()),{stop:h,command:l}}let N=0;class re{constructor(){x(this,"gg",!1);x(this,"size",4);x(this,"score",0);x(this,"times",0);x(this,"tiles",[]);x(this,"cells",[]);x(this,"prevState")}init(e={}){this.gg=!1,this.prevState=void 0,this.size=(e==null?void 0:e.size)??4,this.score=(e==null?void 0:e.score)??0,this.times=(e==null?void 0:e.times)??0,this.tiles=(e==null?void 0:e.tiles)??[],this.updateCells(),this.tiles.length?this.tiles.forEach(s=>s.id=N++):this.popup(2)}move(e){if(this.gg)return;const s=this.score,i=JSON.stringify(this.tiles);this.doMoveTiles(e);const t=this.score!==s||JSON.stringify(this.tiles)!==i;return t&&(this.updateCells(),this.popup(),this.times++,this.prevState={score:s,tiles:i}),t}revert(){this.prevState&&(this.score=this.prevState.score,this.tiles=JSON.parse(this.prevState.tiles),this.prevState=void 0,this.gg=!1,this.times--,this.updateCells())}canIRevert(){return this.prevState!==void 0}popup(e=1){const s=this.getEmptyCells();s.length<e||(se(s,e).forEach(i=>{const t={x:i%this.size,y:Math.floor(i/this.size),score:Math.random()<.9?2:4,id:N++};this.tiles.push(t),this.cells[t.y][t.x]=t}),this.gg=this.isGameOver())}isGameOver(){var e,s,i;if(this.tiles.length<this.size*this.size)return!1;for(let t=0;t<this.size;t++)for(let l=0;l<this.size;l++){const a=(e=this.cells[t][l])==null?void 0:e.score;if(l<this.size-1&&a===((s=this.cells[t][l+1])==null?void 0:s.score)||t<this.size-1&&a===((i=this.cells[t+1][l])==null?void 0:i.score))return!1}return!0}updateCells(){!this.cells||this.cells.length!==this.size||this.cells[0].length!==this.size?this.cells=Array.from({length:this.size},()=>Array.from({length:this.size},()=>null)):this.cells.forEach(e=>e.fill(null)),this.tiles.forEach(e=>this.cells[e.y][e.x]=e)}getEmptyCells(){const e=[];return this.cells.flat().forEach((s,i)=>!s&&e.push(i)),e}doMoveTiles(e){let s,i;e==="up"||e==="down"?(s="y",i=l=>this.cells.map(a=>a[l])):(s="x",i=l=>this.cells[l]);const t=e==="up"||e==="left";for(let l=0;l<this.size;l++){let h=i(l).filter(Boolean),n=0;t?h=this.getMergedTilesOnLine(h.reverse()).reverse():(h=this.getMergedTilesOnLine(h),n=this.size-h.length),h.forEach((c,v)=>c[s]=v+n)}this.tiles=this.tiles.filter(l=>l.score)}getMergedTilesOnLine(e){let s=e.length-1;for(;s>0;){const i=e[s],t=e[s-1];i.score===t.score?(i.score=0,t.score*=2,this.score+=t.score,s-=2):s-=1}return e.filter(i=>i.score)}}function ae(d,e={}){const{size:s=4,bestScoreKey:i="2048_best_score",prevStateKey:t="2048_prev_state",saveWhenExit:l=!0}=e,a=K(new re),{gg:h,score:n,tiles:c,times:v}=P(a),S=U(i,n.value);le({element:d,onMoved:E(a.move,a)});const m=[T(n,()=>S.value=Math.max(S.value,n.value)),M("keydown",p=>{h.value&&p.key==="Enter"&&r()})],r=()=>{a.init({size:s})},f=()=>{try{a.init(JSON.parse(localStorage.getItem(t)||""))}catch{r()}finally{localStorage.removeItem(t)}},$=()=>a.prevState!==void 0;if(l){let p=!1;const u=()=>{p||(p=!0,localStorage.setItem(t,JSON.stringify({size:s,times:v.value,score:n.value,tiles:c.value.map(({x:k,y:G,score:D})=>({x:k,y:G,score:D}))})))};W(()=>u()),m.push(M("pagehide",u))}return R(()=>m.forEach(p=>p())),{gg:h,score:n,times:v,tiles:c,best:S,load:f,newGame:r,canIRevert:$,init:E(a.init,a),revert:E(a.revert,a)}}const y={new:"新游戏",best:"最高分",score:"得分",again:"再来",caption:"移动方块🎯组合出",revert:"撤销上次移动"},oe=j({__name:"tile",props:{score:{}},setup(d){const e=Y(()=>`tile-${d.score<2048?d.score:"super"}`),s=z("tile-popup-no-delay");return T(()=>d.score,(i,t)=>{s.value=t?"tile-merge":"tile-popup"}),(i,t)=>(w(),_("div",{class:H(["h-full w-full flex items-center justify-center rounded font-bold",[e.value,s.value]]),onAnimationend:t[0]||(t[0]=l=>s.value=void 0)},b(i.score),35))}}),ne=I(oe,[["__scopeId","data-v-8ccfe900"]]),ce={class:"select-none g-2048"},de={class:"min-w-80 inline-flex flex-col"},he={class:"mb-2 flex items-center justify-between"},ue={class:"flex items-center gap-2"},fe={class:"text-sm"},ve={class:"text-lg text-white font-bold"},me={class:"score-panel"},pe={class:"text-sm"},ge={class:"text-lg text-white font-bold"},xe={class:"mb-2 flex items-center justify-between"},be={class:"underline underline-offset-2 text-sm"},we={class:"h-12 flex items-center gap-7"},_e=["title"],ye={class:"grid grid-cols-[repeat(var(--n),1fr)] gap-$gap"},Se={class:"h-$side w-$side bg-$c-bg-cell rounded"},$e={class:"absolute inset-$gap"},ke={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white/60 dark:bg-black/60"},ze=j({__name:"main",setup(d){const e=C("scoreBoard"),s=C("tilesBoard"),i=C("toastTemplate"),t=z(4),{gg:l,score:a,best:h,tiles:n,...c}=ae(s);Q(()=>{c.load()});const v=z(a.value);T(a,(m,r)=>{r&&m>r?S(r,m-r):v.value=m});function S(m,r){let $;const p=u=>{$=$??u;const k=Math.min(1,(u-$)/300);v.value=m+Math.floor(r*k),k<1&&window.requestAnimationFrame(p)};if(window.requestAnimationFrame(p),i.value&&e.value){let u=i.value.cloneNode();u.textContent=`+${r}`,u.classList.remove("hidden"),u.addEventListener("animationend",()=>{u==null||u.remove(),u=null}),e.value.append(u)}}return(m,r)=>(w(),_("div",ce,[o("div",de,[o("div",he,[r[3]||(r[3]=o("div",{class:"text-5xl font-bold text-$c-text"},"2048",-1)),o("div",ue,[o("div",{ref_key:"scoreBoard",ref:e,class:"score-panel relative"},[o("div",fe,b(g(y).score),1),o("div",ve,b(v.value),1),o("div",{ref_key:"toastTemplate",ref:i,class:"hidden absolute right-1 bottom-0 text-$c-text text-xl font-bold animation-float-up"},null,512)],512),o("div",me,[o("div",pe,b(g(y).best),1),o("div",ge,b(g(h)),1)])])]),o("div",xe,[o("div",be,b(g(y).caption),1),o("div",we,[V(o("div",{class:"h-full w-12 flex items-center justify-center rounded-full transition cursor-pointer",hover:"bg-black/5 dark:bg-white/10",title:g(y).revert,onClick:r[0]||(r[0]=f=>c.revert())},r[4]||(r[4]=[o("i",{class:"i-lucide-reply"},null,-1)]),8,_e),[[X,c.canIRevert()]]),o("div",{class:"w-22 flex items-center justify-center rounded p-2 text-lg bg-$c-bg-btn text-white cursor-pointer",onClick:r[1]||(r[1]=f=>c.newGame())},b(g(y).new),1)])]),o("div",{ref_key:"tilesBoard",ref:s,class:"relative rounded-lg shadow p-$gap bg-$c-bg-board",style:O({"--n":t.value})},[o("div",ye,[(w(!0),_(B,null,A(t.value*t.value,f=>(w(),_("div",Se))),256))]),o("div",$e,[(w(!0),_(B,null,A(g(n),f=>(w(),_("div",{key:f.id,class:"absolute h-$side w-$side translate-x-$tx translate-y-$ty text-[calc(var(--side)*0.45)] transition-transform duration-200",style:O({"--tx":`calc(var(--side) * ${f.x} + var(--gap) * ${f.x})`,"--ty":`calc(var(--side) * ${f.y} + var(--gap) * ${f.y})`})},[L(ne,{score:f.score},null,8,["score"])],4))),128))]),L(te,{name:"gg"},{default:Z(()=>[g(l)?(w(),_("div",ke,[r[5]||(r[5]=o("div",{class:"mb-5 text-5xl font-bold text-$c-text"},"Game Over",-1)),o("button",{class:"w-24 rounded bg-$c-bg-btn p-2.5 text-center text-xl text-white",onClick:r[2]||(r[2]=f=>c.newGame())},b(g(y).again),1)])):ee("",!0)]),_:1})],4)])]))}}),Te=I(ze,[["__scopeId","data-v-1c90334b"]]);export{Te as default};
